# Trading Platform - Rate Limiting Configuration
# Additional rate limiting rules for specific endpoints

# API general rate limiting
limit_req_zone $binary_remote_addr zone=api_general:10m rate=100r/m;

# Authentication endpoints - strict limits
limit_req_zone $binary_remote_addr zone=auth_login:10m rate=5r/m;
limit_req_zone $binary_remote_addr zone=auth_register:10m rate=3r/m;

# Trading endpoints - higher limits for active trading
limit_req_zone $binary_remote_addr zone=trading_orders:10m rate=60r/m;
limit_req_zone $binary_remote_addr zone=trading_portfolio:10m rate=30r/m;

# Payment endpoints - moderate limits
limit_req_zone $binary_remote_addr zone=payments:10m rate=20r/m;

# Admin endpoints - strict limits
limit_req_zone $binary_remote_addr zone=admin:10m rate=30r/m;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=addr:10m;

# Specific endpoint rate limits
location ~ ^/api/auth/login$ {
    limit_req zone=auth_login burst=5 nodelay;
    limit_conn addr 5;
}

location ~ ^/api/auth/register$ {
    limit_req zone=auth_register burst=3 nodelay;
    limit_conn addr 3;
}

location ~ ^/api/auth/refresh-token$ {
    limit_req zone=auth_login burst=10 nodelay;
}

location ~ ^/api/trading/orders {
    limit_req zone=trading_orders burst=20 nodelay;
    limit_conn addr 10;
}

location ~ ^/api/trading/portfolio {
    limit_req zone=trading_portfolio burst=10 nodelay;
}

location ~ ^/api/payments/ {
    limit_req zone=payments burst=10 nodelay;
    limit_conn addr 5;
}

location ~ ^/api/admin/ {
    limit_req zone=admin burst=5 nodelay;
    limit_conn addr 3;
    
    # Additional IP restriction for admin
    # allow 10.0.0.0/8;
    # allow 172.16.0.0/12;
    # allow 192.168.0.0/16;
    # deny all;
}

# Ban after too many failed requests
limit_req_status 429;
limit_conn_status 503;

# Custom error page for rate limiting
error_page 429 /429.html;
location = /429.html {
    internal;
    return 429 '{"error":"Too Many Requests","message":"Please slow down your requests","retry_after":60}';
    add_header Content-Type application/json;
    add_header Retry-After 60;
}
